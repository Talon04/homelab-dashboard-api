{% extends "_base.html" %}

{% block title %}Homelab Dashboard - Monitor{% endblock %}

{% block head_extra %}
<script>
    document.addEventListener('DOMContentLoaded', async () => {
        try {
            const res = await fetch('/api/config/modules');
            if (res.ok) {
                const data = await res.json();
                const enabled = Array.isArray(data.modules) ? data.modules : [];
                if (!enabled.includes('monitor')) {
                    window.location.href = '/settings';
                }
            }
        } catch (e) { }
    });
</script>
{% endblock %}

{% block content %}
<div id="monitor-root" class="bg-white p-6 rounded shadow mb-6">
    <h2 class="text-xl font-semibold mb-4">Monitor</h2>
    <p class="text-gray-600 mb-4">Select what you want to monitor.</p>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div>
            <label for="monitor-container-select"
                class="block text-sm font-medium text-gray-700 mb-1">Containers</label>
            <select id="monitor-container-select"
                class="block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Select a container...</option>
            </select>
        </div>

        <div>
            <label for="monitor-vm-select" class="block text-sm font-medium text-gray-700 mb-1">VMs</label>
            <select id="monitor-vm-select"
                class="block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Select a VM...</option>
            </select>
        </div>

        <div>
            <label for="monitor-active-select" class="block text-sm font-medium text-gray-700 mb-1">Active
                Monitors</label>
            <select id="monitor-active-select"
                class="block w-full border border-gray-300 rounded-md shadow-sm px-3 py-2 focus:ring-blue-500 focus:border-blue-500">
                <option value="">Select an active monitor...</option>
            </select>
        </div>
    </div>
</div>

<!-- Monitor Display Panel -->
<div id="monitor-display" class="hidden bg-white rounded shadow">
    <!-- Header with toggle -->
    <div class="flex items-center justify-between p-4 border-b border-gray-200">
        <div class="flex items-center gap-3">
            <span id="monitor-display-icon" class="text-2xl">üì¶</span>
            <div>
                <h3 id="monitor-display-title" class="text-lg font-semibold text-gray-900">Container Name</h3>
                <p id="monitor-display-subtitle" class="text-sm text-gray-500">docker ‚Ä¢ container</p>
            </div>
        </div>
        <div class="flex items-center gap-2">
            <span id="monitor-status-badge"
                class="hidden px-2 py-1 text-xs font-medium rounded-full bg-gray-100 text-gray-800">Unknown</span>
            <button id="monitor-toggle-view" class="p-2 text-gray-500 hover:text-gray-700 rounded hover:bg-gray-100"
                title="Toggle Settings/View">
                <!-- Gear icon (settings) -->
                <svg id="icon-settings" class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z">
                    </path>
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
                </svg>
                <!-- Monitor icon (view) -->
                <svg id="icon-monitor" class="w-5 h-5 hidden" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z">
                    </path>
                </svg>
            </button>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="monitor-settings-panel" class="p-6">
        <div class="mb-6">
            <h4 class="font-medium text-gray-900 mb-3">Monitoring Status</h4>
            <div class="flex items-center gap-4">
                <label class="flex items-center gap-2">
                    <input type="checkbox" id="monitor-enabled-toggle"
                        class="h-5 w-5 text-blue-600 rounded focus:ring-blue-500">
                    <span class="text-sm font-medium text-gray-700">Enable Monitoring</span>
                </label>
                <button id="monitor-save-btn"
                    class="px-4 py-2 bg-blue-500 text-white text-sm font-medium rounded hover:bg-blue-600 transition-colors">
                    Save Settings
                </button>
            </div>
        </div>

        <div class="mb-6">
            <h4 class="font-medium text-gray-900 mb-3">Notification Levels</h4>
            <p class="text-sm text-gray-500 mb-2">Configure what events trigger notifications and at what severity level.</p>
            <div class="text-xs text-gray-400 mb-4 p-2 bg-gray-50 rounded border border-gray-200">
                <span class="font-medium">Common severity values:</span>
                <span class="ml-2">1 = Info</span>
                <span class="ml-2">2 = Warning</span>
                <span class="ml-2">3 = Critical</span>
                <span class="ml-2">4 = Emergency</span>
                <span class="ml-2 text-gray-500">(higher = more severe)</span>
            </div>

            <div class="space-y-3">
                <!-- Went Offline -->
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="notify-offline" checked
                            class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                        <div>
                            <span class="text-sm font-medium text-gray-900">Went Offline</span>
                            <p class="text-xs text-gray-500">Container/VM stopped or exited</p>
                        </div>
                    </div>
                    <input type="number" id="notify-offline-severity" value="3" min="1" step="1"
                        class="w-16 border border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Went Online -->
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="notify-online" checked
                            class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                        <div>
                            <span class="text-sm font-medium text-gray-900">Came Online</span>
                            <p class="text-xs text-gray-500">Container/VM started or recovered</p>
                        </div>
                    </div>
                    <input type="number" id="notify-online-severity" value="1" min="1" step="1"
                        class="w-16 border border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- Unreachable -->
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="notify-unreachable" checked
                            class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                        <div>
                            <span class="text-sm font-medium text-gray-900">Unreachable</span>
                            <p class="text-xs text-gray-500">Failed health check or network timeout</p>
                        </div>
                    </div>
                    <input type="number" id="notify-unreachable-severity" value="2" min="1" step="1"
                        class="w-16 border border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-blue-500 focus:border-blue-500">
                </div>

                <!-- High Resource Usage -->
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                    <div class="flex items-center gap-3">
                        <input type="checkbox" id="notify-resources"
                            class="h-4 w-4 text-blue-600 rounded focus:ring-blue-500">
                        <div>
                            <span class="text-sm font-medium text-gray-900">High Resource Usage</span>
                            <p class="text-xs text-gray-500">CPU or memory exceeded threshold</p>
                        </div>
                    </div>
                    <input type="number" id="notify-resources-severity" value="2" min="1" step="1"
                        class="w-16 border border-gray-300 rounded px-2 py-1 text-sm text-center focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>
        </div>

        <div id="monitor-not-enabled-notice" class="p-4 bg-yellow-50 border border-yellow-200 rounded text-yellow-800">
            <p class="text-sm">‚ö†Ô∏è Monitoring is not enabled for this target. Enable it above to start collecting data
                and receiving notifications.</p>
        </div>
    </div>

    <!-- View Panel -->
    <div id="monitor-view-panel" class="hidden p-6">
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <!-- Status Card -->
            <div class="p-4 bg-gray-50 rounded">
                <div class="text-sm text-gray-500 mb-1">Current Status</div>
                <div id="view-status" class="text-xl font-semibold text-green-600">Online</div>
            </div>
            <!-- Uptime Card -->
            <div class="p-4 bg-gray-50 rounded">
                <div class="text-sm text-gray-500 mb-1">Uptime</div>
                <div id="view-uptime" class="text-xl font-semibold text-gray-900">--</div>
            </div>
            <!-- Last Check Card -->
            <div class="p-4 bg-gray-50 rounded">
                <div class="text-sm text-gray-500 mb-1">Last Check</div>
                <div id="view-last-check" class="text-xl font-semibold text-gray-900">--</div>
            </div>
        </div>

        <div class="mb-6">
            <h4 class="font-medium text-gray-900 mb-3">Recent Events</h4>
            <div id="view-events-list" class="space-y-2">
                <p class="text-sm text-gray-500">No events recorded yet.</p>
            </div>
        </div>

        <div>
            <h4 class="font-medium text-gray-900 mb-3">Status History</h4>
            <div id="view-history" class="h-32 bg-gray-50 rounded flex items-center justify-center text-gray-400">
                History chart will appear here
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="/static/monitor.js" defer></script>
{% endblock %}